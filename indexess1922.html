<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Transcription LPC</title>                                                                                                               
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    #inputArea, #outputArea {
      margin-bottom: 20px;
    }
    #originalText {
      font-weight: bold;
      margin-bottom: 5px;
    }
    #phoneticText {
      font-style: italic;
      color: gray;
      margin-bottom: 10px;
    }
    #imageLine {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 5px;
    }
    img {
      height: 80px;
    }
    @media print {
      button, textarea {
        display: none;
      }
    }
  </style>
</head>	
<style>
body {
  margin: 0;
  padding: 0;
  font-family: sans-serif;
}

button {
  z-index: 1000;
}
  @media print {
  body * {
    display: none !important;
  }

  .printable, .printable * {
    display: block !important;
  }

  .printable {
    position: absolute;
    top: 0;
    left: 0;
  }
}
</style>	
<!-- Bouton d'impression -->
<button onclick="window.print()" style="position: fixed; top: 10px; right: 10px; z-index: 1000; padding: 10px 15px; background-color: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
  🖨️ Imprimer
</button>
<body>
<div class="printable">
  <div id="originalText"></div>
  <div id="phoneticText" contenteditable="true" style="border: 1px solid #ccc; padding: 5px;"></div>
  <div id="imageLine"></div>
</div>
  <div id="inputArea">
    <h2>Texte à transcrire</h2>
    <textarea id="userInput" rows="4" cols="80" placeholder="Saisissez votre texte ici..."></textarea><br>
    <button onclick="transcrireTexte()">Transcrire</button>
  </div>

  <div id="outputArea">
    <h2>Transcription en images LPC</h2>
    <div id="originalText"></div>
    <div id="phoneticText" contenteditable="true" style="border: 1px solid #ccc; padding: 5px;"></div>
<small>🔧 Vous pouvez corriger la transcription en cliquant dessus.</small>
<button onclick="majImagesDepuisTexte()">Mettre à jour les images</button>
    <div id="imageLine"></div>
  </div>

  <script>
  const mapping = {
  "1": ["my", "me", "ty", "te", "fy", "fe", "mœ̃", "tœ̃", "fœ̃"],
  "2": ["py", "pe", "dy", "de", "ʒy", "ʒe", "pœ̃", "dœ̃", "ʒœ̃"],
  "3": ["by", "be", "ny", "ne", "ɥy", "ɥe", "bœ̃", "nœ̃", "ɥœ̃"],
  "4": ["ly", "le", "ʃy", "ʃe", "ɲy", "ɲe", "wy", "we", "lœ̃", "ʃœ̃", "ɲœ̃"],
  "5": ["ky", "ke", "vy", "ve", "zy", "ze", "kœ̃", "vœ̃", "zœ̃"],
  "6": ["sy", "se", "ʀy", "ʀe", "sœ̃"],
  "7": ["ɡy", "ɡe", "ɡœ̃"],
  "8": ["jy", "je", "jœ̃", "ŋy", "ŋe", "ŋœ̃"],
  "9": ["mɛ", "mu", "mɔ", "tɛ", "tu", "tɔ", "fɛ", "fu", "fɔ"],
  "10": ["pɛ", "pu", "pɔ", "dɛ", "du", "dɔ", "ʒɛ", "ʒu", "ʒɔ"],
  "11": ["bɛ", "bu", "bɔ", "nɛ", "nu", "nɔ", "ɥɛ", "ɥu", "ɥɔ"],
  "12": ["lɛ", "lu", "lɔ", "ʃɛ", "ʃu", "ʃɔ", "ɲɛ", "ɲu", "ɲɔ", "wɛ", "wu", "wɔ"],
  "13": ["kɛ", "ku", "kɔ", "vɛ", "vu", "vɔ", "zɛ", "zu", "zɔ"],
  "14": ["sɛ", "su", "sɔ", "ʀɛ", "ʀu", "ʀɔ"],
  "15": ["ɡɛ", "ɡu", "ɡɔ"],
  "16": ["jɛ", "ju", "jɔ", "ŋɛ", "ŋu", "ŋɔ"],
  "17": ["mi", "mɔ̃", "mɑ̃", "ti", "tɔ̃", "tɑ̃", "fi", "fɔ̃", "fɑ̃"],
  "18": ["pi", "pɔ̃", "pɑ̃", "di", "dɔ̃", "dɑ̃", "ʒi", "ʒɔ̃", "ʒɑ̃"],
  "19": ["bi", "bɔ̃", "bɑ̃", "ni", "nɔ̃", "nɑ̃", "ɥi", "ɥɔ̃", "ɥɑ̃"],
  "20": ["li", "lɔ̃", "lɑ̃", "ʃi", "ʃɔ̃", "ʃɑ̃", "ɲi", "ɲɔ̃", "ɲɑ̃", "wi", "wɔ̃", "wɑ̃"],
  "21": ["ki", "kɔ̃", "kɑ̃", "vi", "vɔ̃", "vɑ̃", "zi", "zɔ̃", "zɑ̃"],
  "22": ["si", "sɔ̃", "sɑ̃", "ʀi", "ʀɔ̃", "ʀɑ̃"],
  "23": ["ɡi", "ɡɔ̃", "ɡɑ̃"],
  "24": ["ji", "jɔ̃", "jɑ̃", "ŋi", "ŋɔ̃", "ŋɑ̃"],
  "25": ["ma", "mo", "mœ", "ta", "to", "tœ", "fa", "fo", "fœ"],
  "26": ["pa", "po", "pœ", "da", "do", "dœ", "ʒa", "ʒo", "ʒœ"],
  "27": ["ba", "bo", "bœ", "na", "no", "nœ", "ɥa", "ɥo", "ɥœ"],
  "28": ["la", "lo", "lœ", "ʃa", "ʃo", "ʃœ", "ɲa", "ɲo", "ɲœ", "wa", "wo", "wœ"],
  "29": ["ka", "ko", "kœ", "va", "vo", "vœ", "za", "zo", "zœ"],
  "30": ["sa", "so", "sœ", "ʀa", "ʀo", "ʀœ"],
  "31": ["ɡa", "ɡo", "ɡœ"],
  "32": ["ja", "jo", "jœ", "ŋa", "ŋo", "ŋœ"],
  "33": ["mɛ̃", "mø", "mə", "tɛ̃", "tø", "tə", "fɛ̃", "fø", "fə"],
  "34": ["pɛ̃", "pø", "pə", "dɛ̃", "dø", "də", "ʒɛ̃", "ʒø", "ʒə"],
  "35": ["bɛ̃", "bø", "bə", "nɛ̃", "nø", "nə", "ɥɛ̃", "ɥø", "ɥə"],
  "36": ["lɛ̃", "lø", "lə", "ʃɛ̃", "ʃø", "ʃə", "ɲɛ̃", "ɲø", "ɲə", "wɛ̃", "wø", "wə"],
  "37": ["kɛ̃", "kø", "kə", "vɛ̃", "vø", "və", "zɛ̃", "zø", "zə"],
  "38": ["sɛ̃", "sø", "sə", "ʀɛ̃", "ʀø", "ʀə"],
  "39": ["ɡɛ̃", "ɡø", "ɡə"],
  "40": ["jɛ̃", "jø", "jə", "ŋɛ̃", "ŋø", "ŋə"],
  "A": ["y", "e", "œ̃"],
  "B": ["ɛ", "u", "ɔ"],
  "C": ["i", "ɔ̃", "ɑ̃"],
  "D": ["a", "o", "œ"],
  "E": ["ɛ̃", "ø", "ə"],
  "F": ["m", "t", "f"],
  "G": ["p", "d", "ʒ"],
  "H": ["b", "n", "ɥ"],
  "I": ["l", "ʃ", "ɲ", "w"],
  "J": ["k", "v", "z"],
  "K": ["s", "ʀ"],
  "L": ["ɡ"],
  "M": ["j", "ŋ"]
};

    async function transcrireTexte() {
    const texte = document.getElementById("userInput").value;
    if (!texte.trim()) return;

    document.getElementById("originalText").innerText = texte;
    document.getElementById("imageLine").innerHTML = "";
    document.getElementById("phoneticText").innerText = "";

    const response = await fetch("http://127.0.0.1:5000/transcrire", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ texte })
    });

    const data = await response.json();
    let phonemes = data.phonemes;

    // Affiche la transcription phonétique
    document.getElementById("phoneticText").innerText = phonemes;

    // Nettoyage
    phonemes = phonemes.replace(/[\s-]/g, "").replace(/ː/g, "");

    afficherImagesDepuisPhonemes(phonemes);
  }

  function majImagesDepuisTexte() {
    const phoneticText = document.getElementById("phoneticText").innerText;
    if (!phoneticText.trim()) return;

    const phonemes = phoneticText.replace(/[\s-]/g, "").replace(/ː/g, "").replace(/ʁ/g, "ʀ");

    afficherImagesDepuisPhonemes(phonemes);
  }

  function afficherImagesDepuisPhonemes(phonemes) {
  // Normalisation des phonèmes (ʁ traité comme r)
  phonemes = phonemes.replace(/ʁ/g, "ʀ");


  const resultImages = [];
  const resultPhonemes = [];
  let i = 0;
  const maxPhonemeLength = 3;

    while (i < phonemes.length) {
      let match = false;
      for (let len = maxPhonemeLength; len > 0; len--) {
        const segment = phonemes.slice(i, i + len);
        for (const [img, list] of Object.entries(mapping)) {
          if (list.includes(segment)) {
            resultImages.push(`${img}.png`);
            resultPhonemes.push(segment);
            i += len;
            match = true;
            break;
          }
        }
        if (match) break;
      }
      if (!match) {
        i++;
      }
    }

    const imageLine = document.getElementById("imageLine");
    imageLine.innerHTML = "";

    resultImages.forEach((img, index) => {
      const container = document.createElement("div");
      container.style.display = "flex";
      container.style.flexDirection = "column";
      container.style.alignItems = "center";
      container.style.fontSize = "14px";
      container.style.margin = "4px";

      const imageElement = document.createElement("img");
      imageElement.src = `http://127.0.0.1:5000/images/${img}`;
      imageElement.style.height = "100px";

      const phonemeText = document.createElement("span");
      phonemeText.innerText = resultPhonemes[index] || "";

      container.appendChild(imageElement);
      container.appendChild(phonemeText);
      imageLine.appendChild(container);
    });
  }
</script>
